<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Aplikasi Tabungan Firebase</title>
</head>
<body>

<h1>APLIKASI TABUNGAN</h1>

<!-- ================= LOGIN ================= -->
<div id="loginBox">
    <h3>Login Admin</h3>
    <input id="email" placeholder="Email"><br>
    <input id="password" placeholder="Password" type="password"><br>
    <button onclick="login()">Login</button>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" style="display:none;">

    <h2>Dashboard Admin</h2>
    <button onclick="logout()">Logout</button>

    <hr>

    <!-- Tambah Nasabah -->
    <h3>Tambah Nasabah</h3>
    <input id="nama" placeholder="Nama Nasabah">
    <button onclick="tambahNasabah()">Tambah</button>

    <hr>

    <!-- List Nasabah -->
    <h3>Daftar Nasabah</h3>
    <ul id="nasabahList"></ul>

    <hr>

    <!-- Transaksi -->
    <h3>Transaksi Nasabah</h3>

    <select id="nasabahSelect"></select><br><br>

    <select id="jenis">
        <option value="deposit">Setor</option>
        <option value="withdraw">Tarik</option>
    </select>

    <input id="jumlah" type="number" placeholder="Jumlah"><br>
    <input id="catatan" placeholder="Catatan"><br>
    <button onclick="prosesTransaksi()">Proses</button>

    <hr>

    <!-- Riwayat -->
    <h3>Riwayat Transaksi</h3>
    <ul id="riwayat"></ul>
</div>

    <!-- Firebase Library -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // ================== CONFIG FIREBASE ==================
      const firebaseConfig = {
  apiKey: "AIzaSyD2tdSM2wvibgVztT34daOBE0FYKTTIBF4",
  authDomain: "tabungan-702cd.firebaseapp.com",
  databaseURL: "https://tabungan-702cd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tabungan-702cd",
  storageBucket: "tabungan-702cd.firebasestorage.app",
  messagingSenderId: "1089401460941",
  appId: "1:1089401460941:web:5dcef23cd37963bef0b184"
};        
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
        
// ======================================================
//                      LOGIN
// ======================================================

function login() {
    const email = document.getElementById("email").value;
    const pass  = document.getElementById("password").value;

    auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            loadNasabah();
            loadSelectNasabah();
        })
        .catch(err => alert(err.message));
}

function logout() {
    auth.signOut();
    location.reload();
}


// ======================================================
//               TAMBAH NASABAH
// ======================================================

function tambahNasabah() {
    const nama = document.getElementById("nama").value;

    if (!nama) return alert("Nama wajib diisi!");

    db.collection("nasabah").add({
        nama,
        saldo: 0,
        createdAt: new Date()
    }).then(() => {
        alert("Nasabah ditambahkan");
        loadNasabah();
        loadSelectNasabah();
    });
}


// ======================================================
//                 LIST NASABAH + EDIT/HAPUS
// ======================================================

function loadNasabah() {
    const list = document.getElementById("nasabahList");
    list.innerHTML = "";

    db.collection("nasabah").orderBy("createdAt", "desc").get()
    .then(snap => {
        snap.forEach(doc => {
            const data = doc.data();
            const li = document.createElement("li");
            li.innerHTML = `
                ${data.nama} — Saldo: ${data.saldo}
                <button onclick="editNasabah('${doc.id}', '${data.nama}')">Edit</button>
                <button onclick="hapusNasabah('${doc.id}')">Hapus</button>
            `;
            list.appendChild(li);
        });
    });
}

function editNasabah(id, namaLama) {
    const namaBaru = prompt("Nama baru:", namaLama);
    if (!namaBaru) return;

    db.collection("nasabah").doc(id)
        .update({ nama: namaBaru })
        .then(() => {
            alert("Nama nasabah diperbarui");
            loadNasabah();
            loadSelectNasabah();
        });
}

async function hapusNasabah(id) {
    if (!confirm("Yakin ingin menghapus nasabah ini beserta semua transaksi?")) return;

    const nasabahRef = db.collection("nasabah").doc(id);
    const transRef = nasabahRef.collection("transactions");

    // hapus semua transaksi dahulu
    const transSnap = await transRef.get();
    const batch = db.batch();
    transSnap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    // lalu hapus nasabah
    await nasabahRef.delete();

    alert("Nasabah dan semua transaksinya dihapus");
    loadNasabah();
    loadSelectNasabah();
}


// ======================================================
//               LOAD SELECT NASABAH
// ======================================================

function loadSelectNasabah() {
    const select = document.getElementById("nasabahSelect");
    select.innerHTML = "";

    db.collection("nasabah").orderBy("createdAt","desc").get()
        .then(snap => {
            snap.forEach(doc => {
                const opt = document.createElement("option");
                opt.value = doc.id;
                opt.textContent = doc.data().nama;
                select.appendChild(opt);
            });

            loadRiwayat();
        });
}



// ======================================================
//                   PROSES TRANSAKSI
// ======================================================

function prosesTransaksi() {
    const id = document.getElementById("nasabahSelect").value;
    const jenis = document.getElementById("jenis").value;
    const jumlah = Number(document.getElementById("jumlah").value);
    const catatan = document.getElementById("catatan").value;

    if (!jumlah || jumlah <= 0) return alert("Jumlah tidak valid");

    const nasabahRef = db.collection("nasabah").doc(id);

    db.runTransaction(async trx => {
        const snap = await trx.get(nasabahRef);
        const data = snap.data();

        let saldoBaru = data.saldo;

        if (jenis === "deposit") {
            saldoBaru += jumlah;
        } else {
            if (jumlah > saldoBaru) throw "Saldo tidak cukup!";
            saldoBaru -= jumlah;
        }

        trx.update(nasabahRef, { saldo: saldoBaru });

        const tRef = nasabahRef.collection("transactions").doc();
        trx.set(tRef, {
            type: jenis,
            amount: jumlah,
            note: catatan,
            time: new Date()
        });
    })
    .then(() => {
        alert("Transaksi berhasil!");
        loadNasabah();
        loadRiwayat();
    })
    .catch(err => alert(err));
}


// ======================================================
//               RIWAYAT TRANSAKSI + EDIT/HAPUS
// ======================================================

function loadRiwayat() {
    const id = document.getElementById("nasabahSelect").value;
    const list = document.getElementById("riwayat");
    list.innerHTML = "";

    db.collection("nasabah").doc(id)
        .collection("transactions")
        .orderBy("time", "desc")
        .get()
        .then(snap => {
            snap.forEach(doc => {
                const t = doc.data();
                const li = document.createElement("li");

                const waktu = t.time.toDate().toLocaleString();

                li.innerHTML = `
                    ${waktu} — ${t.type} — ${t.amount} — ${t.note}
                    <button onclick="editTransaksi('${id}', '${doc.id}', '${t.type}', ${t.amount}, '${t.note}')">Edit</button>
                    <button onclick="hapusTransaksi('${id}', '${doc.id}', '${t.type}', ${t.amount})">Hapus</button>
                `;

                list.appendChild(li);
            });
        });
}


// ================== EDIT TRANSAKSI ==================

async function editTransaksi(nasabahId, transId, jenisLama, amountLama, noteLama) {
    const jumlahBaru = Number(prompt("Jumlah baru:", amountLama));
    if (!jumlahBaru || jumlahBaru <= 0) return alert("Jumlah tidak valid");

    const catatanBaru = prompt("Catatan baru:", noteLama) || noteLama;

    const nasabahRef = db.collection("nasabah").doc(nasabahId);
    const transRef = nasabahRef.collection("transactions").doc(transId);

    await db.runTransaction(async trx => {
        const snap = await trx.get(nasabahRef);
        let saldo = snap.data().saldo;

        // batalkan transaksi lama
        if (jenisLama === "deposit") saldo -= amountLama;
        else saldo += amountLama;

        // terapkan transaksi baru (deposit selalu +)
        saldo += jumlahBaru;

        trx.update(nasabahRef, { saldo });

        trx.update(transRef, {
            amount: jumlahBaru,
            note: catatanBaru,
            time: new Date()
        });
    });

    alert("Transaksi diperbarui");
    loadNasabah();
    loadRiwayat();
}


// ================== HAPUS TRANSAKSI ==================

async function hapusTransaksi(nasabahId, transId, jenis, amount) {
    if (!confirm("Yakin ingin menghapus transaksi ini?")) return;

    const nasabahRef = db.collection("nasabah").doc(nasabahId);
    const transRef = nasabahRef.collection("transactions").doc(transId);

    await db.runTransaction(async trx => {
        const snap = await trx.get(nasabahRef);
        let saldo = snap.data().saldo;

        if (jenis === "deposit") saldo -= amount;
        else saldo += amount;

        trx.update(nasabahRef, { saldo });
        trx.delete(transRef);
    });

    alert("Transaksi dihapus");
    loadNasabah();
    loadRiwayat();
}
</script>

</body>
</html>







